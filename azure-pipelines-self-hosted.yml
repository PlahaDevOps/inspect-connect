# Self-hosted agent pipeline for Inspect Connect

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - client/*
      - server/*
      - azure-pipelines-self-hosted.yml

variables:
  nodeVersion: '20.x'

stages:
- stage: BuildAndDeploy
  displayName: 'Build and Deploy'
  jobs:
  - job: BuildAndDeployAll
    displayName: 'Build and Deploy Everything'
    pool:
      name: 'inspect-connect-agents'
      demands:
        - agent.name -equals inspect-connect-mac-agent

    steps:
    # Install Node.js via NodeTool
    - task: NodeTool@0
      inputs:
        versionSpec: $(nodeVersion)
      displayName: 'Use Node.js $(nodeVersion)'

    - script: |
        node --version
        npm --version
        npm install -g typescript
        tsc --version
      displayName: 'Verify Node.js & TypeScript'

    # Install Frontend Dependencies
    - script: |
        cd client
        npm ci
      displayName: 'Install Frontend Dependencies'
      workingDirectory: $(System.DefaultWorkingDirectory)/client

    # Optional: Type-check without failing build
    - script: |
        cd client
        npx tsc --noEmit || true
      displayName: 'Type Check (Non-blocking)'
      continueOnError: true
      workingDirectory: $(System.DefaultWorkingDirectory)/client

    # Build Frontend
    - script: |
        cd client
        npm run build
      displayName: 'Build Frontend'
      workingDirectory: $(System.DefaultWorkingDirectory)/client

    # Deploy Frontend
    - task: AzureWebApp@1
      inputs:
        azureSubscription: 'inspect-connect-acr'
        appName: 'inspect-connect-test'
        package: '$(System.DefaultWorkingDirectory)/client/dist'
        appSettings: |
          -VITE_API_URL https://inspect-connect-api-test-bgb3gea5c0ezfkfe.canadacentral-01.azurewebsites.net
          -WEBSITES_PORT 80
          -PM2_SERVE_PATH /home/site/wwwroot
        startupCommand: 'pm2 serve /home/site/wwwroot --spa --no-daemon'
      displayName: 'Deploy Frontend to App Service'

    # Install Backend Dependencies
    - script: |
        cd server
        npm ci
      displayName: 'Install Backend Dependencies'
      workingDirectory: $(System.DefaultWorkingDirectory)/server

    # Build Backend
    - script: |
        cd server
        npm run build
      displayName: 'Build Backend'
      workingDirectory: $(System.DefaultWorkingDirectory)/server

    # Archive Backend for Deployment
    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)/server'
        includeRootFolder: false
        archiveType: zip
        archiveFile: '$(Build.ArtifactStagingDirectory)/server.zip'
        replaceExistingArchive: true
      displayName: 'Archive Backend'

    # Deploy Backend
    - task: AzureWebApp@1
      inputs:
        azureSubscription: 'inspect-connect-acr'
        appName: 'inspect-connect-api-test'
        package: '$(Build.ArtifactStagingDirectory)/server.zip'
        appSettings: |
          -MONGODB_URI $(MONGODB_URI)
          -JWT_SECRET $(JWT_SECRET)
          -SENDGRID_API_KEY $(SENDGRID_API_KEY)
          -TWILIO_ACCOUNT_SID $(TWILIO_ACCOUNT_SID)
          -TWILIO_AUTH_TOKEN $(TWILIO_AUTH_TOKEN)
          -CLOUDINARY_CLOUD_NAME $(CLOUDINARY_CLOUD_NAME)
          -CLOUDINARY_API_KEY $(CLOUDINARY_API_KEY)
          -CLOUDINARY_API_SECRET $(CLOUDINARY_API_SECRET)
          -SCM_DO_BUILD_DURING_DEPLOYMENT true
          -WEBSITE_NODE_DEFAULT_VERSION ~20
      displayName: 'Deploy Backend to App Service'

    # Success Message
    - script: |
        echo "âœ… Pipeline completed successfully!"
        echo "Frontend URL: https://inspect-connect-test-fyanc3gpfacngbau.canadacentral-01.azurewebsites.net"
        echo "Backend URL: https://inspect-connect-api-test-bgb3gea5c0ezfkfe.canadacentral-01.azurewebsites.net"
      displayName: 'Pipeline Status and URLs'
